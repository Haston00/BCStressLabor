<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Breigan Charlotte Financial Stress Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f0f2f5; /* Light Gray Background */
        }
        .card {
            @apply bg-white p-6 rounded-xl shadow-lg border border-gray-200;
        }
        .label {
            @apply text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2;
        }
        .value {
            @apply text-3xl sm:text-4xl font-extrabold text-gray-800;
        }
        .input-field {
            @apply w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500;
        }

        /* Briegan Color Scheme */
        .header-title {
             color: #f7941d; /* Briegan Orange/Gold */
        }
        .status-good { 
            color: #16a34a; /* Professional Green */
        }
        .status-bad { 
            color: #dc2626; /* Professional Red */
        }
        
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <header class="mb-8 border-b pb-4 border-gray-300">
            <h1 class="text-3xl sm:text-4xl font-bold header-title text-center">Breigan Charlotte Financial Stress Test</h1>
            <!-- Project Info Section -->
            <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-4 items-end">
                <div>
                    <label for="jobName" class="label">Job Name</label>
                    <input type="text" id="jobName" class="input-field" value="Rowan-Salisbury 3-8">
                </div>
                <div>
                    <label for="jobNumber" class="label">Job Number</label>
                    <input type="text" id="jobNumber" class="input-field" value="15784">
                </div>
                <div>
                    <label for="projectManager" class="label">Project Manager</label>
                    <input type="text" id="projectManager" class="input-field" value="Ibrahim Kuraydi">
                </div>
                <div>
                    <label for="reportDate" class="label">Date</label>
                    <input type="date" id="reportDate" class="input-field">
                </div>
            </div>
        </header>

        <!-- Top Level KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="card">
                <h2 class="label">Team's Projection Profit</h2>
                <p id="teamProfit" class="value status-good">$0</p>
                <p id="teamMargin" class="text-gray-600 font-medium">0.00% Margin</p>
            </div>
            <div class="card">
                <h2 class="label">Stress Test Profit</h2>
                <p id="stressTestProfit" class="value status-good">$0</p>
                <p id="stressTestMargin" class="text-gray-600 font-medium">0.00% Margin</p>
            </div>
            <div class="card">
                <h2 class="label">Impact of Labor & Burden Overrun</h2>
                <p id="forecastDelta" class="value status-good">$0</p>
                <p class="text-gray-600 font-medium">Modeled Risk to Profit</p>
            </div>
        </div>
        
        <!-- Input Card -->
        <div class="mt-6 card">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Craft Labor Overrun Scenario</h2>
             <p class="text-gray-600 mb-6 max-w-4xl">Use these inputs to model the impact of craft labor inefficiency on your final profit. This will adjust the "Stress Test Profit" in real-time.</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                 <div>
                    <label for="contractAmount" class="label">Contract Value ($)</label>
                    <input type="number" id="contractAmount" class="input-field" value="1655402.25" oninput="runAnalysis()">
                </div>
                <div>
                    <label for="weeksRemaining" class="label">Weeks Remaining</label>
                    <input type="number" id="weeksRemaining" class="input-field" value="2" oninput="runAnalysis()">
                </div>
                <div>
                    <label for="avgManpower" class="label">Avg. Weekly Craft Manpower</label>
                    <input type="number" id="avgManpower" class="input-field" value="5" oninput="runAnalysis()">
                </div>
                <div>
                    <label for="hoursPerWorker" class="label">Hrs per Worker/Wk</label>
                    <input type="number" id="hoursPerWorker" class="input-field" value="45" oninput="runAnalysis()">
                </div>
                 <div>
                    <label for="laborCostPerHour" class="label">Craft Labor Cost/Hr ($)</label>
                    <input type="number" id="laborCostPerHour" class="input-field" value="28.59" oninput="runAnalysis()">
                </div>
                 <div>
                    <label for="burdenRate" class="label">Craft Labor Burden Rate (%)</label>
                    <input type="number" id="burdenRate" class="input-field" value="19.00" oninput="runAnalysis()">
                </div>
            </div>
        </div>

        <!-- Deep Dive Analysis Table -->
        <div class="mt-6 card">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Cost Breakdown: Team's Projection vs. Stress Test</h2>
            <div class="overflow-x-auto">
                <table class="w-full min-w-[768px] sm:min-w-full">
                    <thead class="border-b-2 border-gray-200">
                        <tr>
                            <th class="p-3 text-sm font-semibold text-gray-600 text-left">Category</th>
                            <th class="p-3 text-sm font-semibold text-gray-600 text-center">Spent to Date ($)</th>
                            <th class="p-3 text-sm font-semibold text-gray-600 text-center">Proj. Remaining ($)</th>
                            <th class="p-3 text-sm font-semibold text-gray-600 text-center">Team's Projection (EAC)</th>
                            <th class="p-3 text-sm font-semibold text-gray-600 text-center">Stress Test (EAC)</th>
                            <th class="p-3 text-sm font-semibold text-gray-600 text-center">Variance</th>
                        </tr>
                    </thead>
                    <tbody id="analysisTableBody" class="text-gray-700">
                        <!-- JS will populate this -->
                    </tbody>
                    <tfoot class="border-t-2 border-gray-300 font-bold text-gray-800">
                         <tr>
                            <td class="p-3 text-left font-bold">Total</td>
                            <td class="p-3 text-right" id="totalSpent"></td>
                            <td class="p-3 text-right" id="totalRemaining"></td>
                            <td class="p-3 text-right" id="totalTeamEAC"></td>
                            <td class="p-3 text-right" id="totalStressTestEAC"></td>
                            <td class="p-3 text-right" id="totalVariance"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

    </div>
    <footer class="text-center p-4 mt-6 text-gray-500 text-sm">
        &copy; Brandon Haston
    </footer>

    <script>
        // --- NEW Initial Project Data Structure based on the user's latest image ---
        const initialCosts = [
            { name: 'Labor',                 spent: 299770, remaining: 12869, type: 'labor' },
            { name: 'Burden',                spent: 77062,  remaining: 2971,  type: 'burden' },
            { name: 'Materials',             spent: 661132, remaining: 12271,  type: 'other' },
            { name: 'Equipment',             spent: 110742, remaining: 1527,   type: 'other' },
            { name: 'Subcontract',           spent: 239440, remaining: 9819,   type: 'other' },
            { name: 'Other',                 spent: 75261,  remaining: 3552,   type: 'other' }
        ];

        // --- Utility Functions ---
        const formatCurrency = (value) => {
            if (isNaN(value)) return '$0';
            const sign = value < 0 ? '-' : '';
            return `${sign}$${Math.abs(value).toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
        };
        
        const formatNumber = (value, decimals = 2) => {
            if(isNaN(value)) return 'N/A';
            return value.toFixed(decimals);
        }

        // --- Main Analysis Function ---
        function runAnalysis() {
            // Get user inputs for core financials and labor scenario
            const contractAmount = parseFloat(document.getElementById('contractAmount').value) || 0;
            const burdenRate = (parseFloat(document.getElementById('burdenRate').value) || 0) / 100;
            const weeksRemaining = parseFloat(document.getElementById('weeksRemaining').value) || 0;
            const avgManpower = parseFloat(document.getElementById('avgManpower').value) || 0;
            const hoursPerWorker = parseFloat(document.getElementById('hoursPerWorker').value) || 0;
            const laborCostPerHour = parseFloat(document.getElementById('laborCostPerHour').value) || 0;

            const tableBody = document.getElementById('analysisTableBody');
            
            let totalSpent = 0;
            let totalRemaining = 0;
            let totalTeamEAC = 0;
            let totalStressTestEAC = 0;

            // --- Calculate the forward-looking craft labor costs for the stress test ---
            const projectedRemainingHours = weeksRemaining * avgManpower * hoursPerWorker;
            const projectedRemainingDirectLaborCost = projectedRemainingHours * laborCostPerHour;
            const projectedRemainingBurdenCost = projectedRemainingDirectLaborCost * burdenRate;
            
            // Loop through each row in the table to get current cost data
            Array.from(tableBody.rows).forEach(row => {
                 // Get the current values from the input fields in the table
                const inputs = row.querySelectorAll('input');
                const spent = parseFloat(inputs[0].value) || 0;
                const remaining = parseFloat(inputs[1].value) || 0;
                const type = row.dataset.type;
                
                // 1. Team Projection is always the baseline (Spent + Projected Remaining from inputs)
                const teamEAC = spent + remaining;
                let stressTestEAC = teamEAC; // Start with the team's projection

                // ONLY adjust the variable Craft Labor and its associated Burden
                if (type === 'labor') {
                    stressTestEAC = spent + projectedRemainingDirectLaborCost;
                } else if (type === 'burden') {
                    stressTestEAC = spent + projectedRemainingBurdenCost;
                }

                const variance = teamEAC - stressTestEAC;
                const varianceClass = variance >= 0 ? 'text-green-600' : 'text-red-600';
                
                // Update the calculated cells in the row
                row.cells[3].textContent = formatCurrency(teamEAC);
                row.cells[4].textContent = formatCurrency(stressTestEAC);
                row.cells[5].textContent = formatCurrency(variance);
                row.cells[5].className = `p-3 font-bold text-right ${varianceClass}`;

                totalSpent += spent;
                totalRemaining += remaining;
                totalTeamEAC += teamEAC;
                totalStressTestEAC += stressTestEAC;
            });

            
            // --- Update Totals and KPIs ---
            const teamProfit = contractAmount - totalTeamEAC;
            const stressTestProfit = contractAmount - totalStressTestEAC;
            const forecastDelta = stressTestProfit - teamProfit;
            
            document.getElementById('teamProfit').textContent = formatCurrency(teamProfit);
            document.getElementById('teamMargin').textContent = `${formatNumber(teamProfit / contractAmount * 100)}% Margin`;
            
            const stressProfitEl = document.getElementById('stressTestProfit');
            stressProfitEl.textContent = formatCurrency(stressTestProfit);
            document.getElementById('stressTestMargin').textContent = `${formatNumber(stressTestProfit / contractAmount * 100)}% Margin`;
            stressProfitEl.classList.remove('status-good', 'status-bad');
            stressProfitEl.classList.add(stressTestProfit < 0 ? 'status-bad' : 'status-good');

            const deltaEl = document.getElementById('forecastDelta');
            deltaEl.textContent = formatCurrency(forecastDelta);
            deltaEl.classList.remove('status-good', 'status-bad');
            deltaEl.classList.add(forecastDelta >= 0 ? 'status-good' : 'status-bad');

            const totalVariance = totalTeamEAC - totalStressTestEAC;
            // Update table footer with all totals
            document.getElementById('totalSpent').textContent = formatCurrency(totalSpent);
            document.getElementById('totalRemaining').textContent = formatCurrency(totalRemaining);
            document.getElementById('totalTeamEAC').textContent = formatCurrency(totalTeamEAC);
            document.getElementById('totalStressTestEAC').textContent = formatCurrency(totalStressTestEAC);
            
            const totalVarianceEl = document.getElementById('totalVariance');
            totalVarianceEl.textContent = formatCurrency(totalVariance);
            totalVarianceEl.classList.remove('text-green-600', 'text-red-600');
            totalVarianceEl.classList.add(totalVariance >= 0 ? 'text-green-600' : 'text-red-600');
        }

        // --- Function to build the table initially ---
        function buildTable() {
            const tableBody = document.getElementById('analysisTableBody');
            tableBody.innerHTML = ''; // Clear table before rebuilding
            initialCosts.forEach(item => {
                const row = tableBody.insertRow();
                row.dataset.type = item.type;
                
                row.innerHTML = `
                    <td class="p-3 font-semibold text-gray-800 text-left">${item.name}</td>
                    <td class="p-2 text-center"><input type="number" class="input-field text-right" value="${item.spent}" oninput="runAnalysis()"></td>
                    <td class="p-2 text-center"><input type="number" class="input-field text-right" value="${item.remaining}" oninput="runAnalysis()"></td>
                    <td class="p-3 text-right"></td>
                    <td class="p-3 text-right"></td>
                    <td class="p-3 font-bold text-right"></td>
                `;
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('reportDate').valueAsDate = new Date();
            buildTable();
            runAnalysis();
        });
    </script>
</body>
</html>
